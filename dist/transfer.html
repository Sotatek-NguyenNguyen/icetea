<html>
<head>
    <title>tchain - transfer</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <style>
        input{
            width: 400px;
        }
    </style>
</head>
<body>
    <div id="content">
        <nav id="menu">
            <a href="/">Scan</a>
            <a href="/transfer.html">Transfer</a>
            <a href="/deploy.html">Deploy Contract</a>
            <a href="/contract.html">Read/Write Contract</a>
            <a href="/private_key.html">Private key</a>
        </nav>
        <h1>Transfer</h1>
        <h2>Your private key used to sign tx</h2>
        <input type="text" id="private_key" value="5K4kMyGz839wEsG7a9xvPNXCmtgFE5He2Q8y9eurEQ4uNgpSRq7">
        <h2>Your data</h2>
        <form id="form_tx">
            <p><label>From: <input type="text" value="EOS617BFqg1QhNtsJiNiWz9jGpsm5iAJKqWQBhhk36KjvUFqNkh47" placeholder="enter your public key" name="from" required autofocus></label></p>
            <p><label>To: <input type="text" value="vinh" name="to" required></label></p>
            <p><label>Value: <input type="number" value="100" name="value" required></label></p>
            <p><label>Fee: <input type="number" value="1" name="fee"></label></p>
            <p><button style="padding: 8px 32px" onClick="signTx()">Send</button>
        </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/eosjs-ecc@4.0.4/lib/eosjs-ecc.min.js"
    integrity="sha512-dYFDmK/d9r3/NCp6toLtfkwOjSMRBaEzaGAx1tfRItC0nsI0hVLERk05iNBQR7uDNI7ludYhcBI4vUiFHdjsTQ=="
    crossorigin="anonymous"></script>
    <script>        
        $('#form_tx').submit(false);
        
        function signTx(){
            var data = $('#form_tx').serializeArray().reduce(function(obj, item) {
                    obj[item.name] = item.value;
                    return obj;
                }, {});
            var privateKey = $("#private_key").val()
            var pubkey = data.from
            var signature = eosjs_ecc.sign(JSON.stringify(data), privateKey)

            //submit tx
            $.ajax({url: "/api/send_tx", 
                    method: "POST",
                    data: {
                        signature, pubkey, data: JSON.stringify(data)
                    },
                    success: function(result){
                        if(result.success){
                            window.location.href = '/?' + encodeURIComponent("Transaction broadcasted successfully.")
                        }else{
                            alert(result.error)
                        }
                        console.log(result)
                }});
        }
    </script>
</body>

</html>